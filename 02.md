# Tutorial 2: Ensemble refinement with EMMIVox

These are the steps to do ensemble modelling using a cryo-EM map and EMMIVox.

**Note 1**: To do ensemble modelling you need to first complete the single-structure refinement tutorial.

**Note 2**: all the python scripts are contained in the `scripts` folder. Please run each step of the tutorial in the dedicated subfolder of `tutorials/2-ensemble` referred to as **Working directory**.

## 0. Production 

   * Prepare the input files and directories for ensemble modelling with 16 replicas using:

     `bash prepare_PLUMED_Ensemble_input.sh 16`

     You can specify fewer or more replicas depending on the number of CPU cores and GPUs available.

     The generated PLUMED input file, called `plumed_EMMI.dat`, should look like this:

     ```plumed
     # include topology info
     MOLINFO STRUCTURE=../../../1-refinement/3-Map-Scaling/step3_input_xtc.pdb WHOLE
     # define map atoms
     system-map: GROUP NDX_FILE=../../../1-refinement/0-Building/index.ndx NDX_GROUP=System-MAP
     # make map atoms whole
     WHOLEMOLECULES ...
     ADDREFERENCE EMST
     ENTITY0=system-map STRIDE=4
     ... WHOLEMOLECULES
     # create EMMI score
     EMMIVOX ...
     # name of this action
     LABEL=emmi
     # general parameters
     TEMP=300.0 NL_STRIDE=50 NL_DIST_CUTOFF=1.0 NL_GAUSS_CUTOFF=3.0
     # define atoms for cryo-EM restraint and read experimental data
     ATOMS=system-map DATA_FILE=../../../1-refinement/1-Map-Preparation/emd_plumed_aligned.dat
     # info about the experimental map
     NORM_DENSITY=684.480896 RESOLUTION=0.19
     # data likelihood (or noise model): Marginal
     SIGMA_MIN=0.2 GPU
     # output: in production write with the frequency at which XTC/TRR are written
     STATUS_FILE=EMMIStatus WRITE_STRIDE=5000
     # comment this if you have a hetero-complex
     BFACT_NOCHAIN
     # in ensemble modelling, you should *NOT* sample Bfactors, but read from input
     # the minimum Bfactor found in single-structure refinement
     # and keep constant and the same for all residues
     BFACT_READ
     # scale factor
     SCALE=1.3
     # correlation
     CORRELATION
     ...
     # in production, apply bias to system
     emr: BIASVALUE ARG=emmi.scoreb STRIDE=4
     # print output to file
     PRINT ARG=emmi.* FILE=COLVAR STRIDE=5000
     ```

   * Run a 10-ns long simulation in parallel using 16 MPI processes, each one parallelized on multiple CPU cores (`$OMP_NUM_THREADS`). 
     You might need to adapt this line depending on your command to submit parallel jobs, i.e. srun, mpiexec, or mpirun.

     `srun -N 16 gmx_mpi mdrun -pin on -ntomp $OMP_NUM_THREADS -plumed plumed_EMMI.dat -s production.tpr -multidir rep-* -nsteps 5000000`

     **Note**: Usually a good setup for multiple-replica simulations is to allocate 1 GPU to each replica, and 6-10 CPU cores (`$OMP_NUM_THREADS`) per replica depending on the system size. You can safely allocate (using your job manager, i.e. slurm or pbs) 2 replicas on the same GPU without significant loss in performance.  

**Working directory**: `0-Production` 

## 1. Postprocessing and validation 

   * We first need to concatenate the trajectories of all replicas and fix discontinuities due to Periodic Boundary Conditions:

     `bash prepare_PLUMED_Ensemble_analysis.sh`

   * Now we need to transform back the concatenated trajectory `traj-all-PBC.xtc` to fit the original cryo-EM map 
     using the `transformation.dat` created during the map preparation stage of single-structure refinement:

     `python align-XTC.py conf_map.pdb traj-all-PBC.xtc traj-all-PBC-align.xtc ../../1-refinement/1-Map-Preparation/transformation.dat` 

   * We add a Bfactor column to the reference PDB (`conf_map.pdb`). These Bfactors are the
     same for all residues, they were set before doing ensemble modelling equal to the minimum Bfactor found in the single-structure refinement:

     `python add-BFACT.py conf_map.pdb ../0-Production/EMMIStatus conf_EMMIVOX.pdb`

   * And finally we calculate model fit to the data (CC_mask) of the original PDB `7P6A.pdb` and of our ensemble:

     `python cryo-EM_validate.py ../../1-refinement/1-Map-Preparation/emd_13223.map --pdbA=../../1-refinement/1-Map-Preparation/7P6A.pdb --pdbC=conf_EMMIVOX.pdb --trjC=traj-all-PBC-align.xtc --threshold=0.0`

     **Note**: if you performed energy minimization and validation after single-structure refinement, you can compare also with the EMMIVOX model:

     `python cryo-EM_validate.py ../../1-refinement/1-Map-Preparation/emd_13223.map --pdbA=../../1-refinement/5-Analysis/conf_EMMIVOX.pdb --pdbC=conf_EMMIVOX.pdb --trjC=traj-all-PBC-align.xtc --threshold=0.0`

**Working directory**: `1-Analysis`
